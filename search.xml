<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Blog å¯åŠ¨ï¼</title>
    <url>/2023/10/16/0000/</url>
    <content><![CDATA[<p>ğŸ”¸è®°å½•ä¸€ä¸ªå¼€å§‹ï¼Œè¿™é‡Œä»€ä¹ˆä¹Ÿæ²¡æœ‰ï¼Œå¾€ä¸Šç¿»ç¿»å§ï¼ğŸ˜‰ğŸ˜‰ğŸ˜‰</p>
]]></content>
  </entry>
  <entry>
    <title>Telegraf + InfluxDB2 + Grafana æ­å»ºå¯ç›‘æ§ç¯å¢ƒ</title>
    <url>/2023/11/17/0002/</url>
    <content><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>ç¬”è€…å°†æ­å»ºä¸€ä¸ª Telegraf + Influxdb + Grafana å¯ç›‘æ§ç¯å¢ƒï¼Œé€šè¿‡è¿™å¥—å·¥å…·ç»„åˆï¼Œå¯ä»¥æ„å»ºå®æ—¶ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶åˆ†æå’Œå±•ç¤ºå„ç§æŒ‡æ ‡å’Œæ•°æ®ï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£å’Œç®¡ç†ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ã€‚</p>
<ul>
<li><strong>Telegraf</strong> æ”¶é›†æ•°æ®ï¼šå¼€æºçš„æœåŠ¡å™¨ä»£ç†ç¨‹åºï¼Œç”¨äºæ”¶é›†ã€å¤„ç†å’Œå‘é€æŒ‡æ ‡æ•°æ®ã€‚</li>
<li><strong>Influxdb</strong> å­˜å‚¨æ•°æ®ï¼šå¼€æºçš„æ—¶åºæ•°æ®åº“ï¼Œä¸“é—¨ç”¨äºå­˜å‚¨å’ŒæŸ¥è¯¢æ—¶é—´ç›¸å…³çš„æ•°æ®ï¼Œæ—¨åœ¨ä¸ºç›‘æ§ã€åˆ†æå’Œå¯è§†åŒ–åº”ç”¨ç¨‹åºæä¾›é«˜æ€§èƒ½çš„æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆã€‚</li>
<li><strong>Grafana</strong> å±•ç¤ºæ•°æ®ï¼šå¼€æºçš„æ•°æ®å¯è§†åŒ–å’Œç›‘æ§å¹³å°ï¼Œç”¨äºå®æ—¶ç›‘æ§ã€åˆ†æå’Œå¯è§†åŒ–å„ç§æŒ‡æ ‡æ•°æ®ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„å›¾è¡¨ã€ä»ªè¡¨ç›˜å’Œè­¦æŠ¥åŠŸèƒ½ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿç›´è§‚åœ°ç†è§£å’Œåˆ†ææ•°æ®ã€‚</li>
</ul>
<div align=center>
  <img src=/images/public/APM-Diagram-2.png />
</div>

<h1 id="äºŒã€ç¯å¢ƒ"><a href="#äºŒã€ç¯å¢ƒ" class="headerlink" title="äºŒã€ç¯å¢ƒ"></a>äºŒã€ç¯å¢ƒ</h1><ul>
<li><p><strong>å·¥ä½œç¯å¢ƒ</strong></p>
<p><strong>ç¡¬ä»¶:</strong> æ ‘è“æ´¾4B 8G&#x2F;64bit<br><strong>ç³»ç»Ÿ:</strong> Ubuntu 22.04.3 LTS (GNU&#x2F;Linux 5.15.0-1042-raspi aarch64)<br><strong>Docker:</strong> Standalone 20.10.24</p>
</li>
<li><p><strong>æ­å»ºç¯å¢ƒ</strong></p>
<p><strong>Telegraf:</strong> 1.21.4+ds1-0ubuntu2<br><strong>Influxdb:</strong> 2.7.4<br><strong>Grafana:</strong> 10.2.1-ubuntu</p>
</li>
</ul>
<h1 id="ä¸‰ã€æ­£æ–‡"><a href="#ä¸‰ã€æ­£æ–‡" class="headerlink" title="ä¸‰ã€æ­£æ–‡"></a>ä¸‰ã€æ­£æ–‡</h1><ul>
<li><p><strong>åœ¨Dockerä¸­å®‰è£…Influxdb</strong></p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">docker</span> pull influxdb</span><br><span class="line"><span class="attribute">docker</span> run -d --name influxdb -p <span class="number">8086</span>:<span class="number">8086</span> influxdb</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Influxdbé¢„å¤‡å·¥ä½œ</strong><br>æ‰“å¼€<a href="http://127.0.0.1:8086/">http://127.0.0.1:8086</a> å¹¶ç‚¹å‡»InfluxDBç³»ç»Ÿè‡ªå¸¦çš„ä»ªè¡¨ç›˜</p>
<div align=center>
  <img src=/images/2023.11.17/203950.png />
</div>
ç‚¹å‡»çœ‹åˆ°ç³»ç»Ÿçš„è¿è¡Œä¿¡æ¯è¯´æ˜InfluxDBæ­£åœ¨è¿è¡Œ
<div align=center>
  <img src=/images/2023.11.17/204100.png />
</div>
è¿›å…¥ç®¡ç†é¢æ¿å¹¶æ·»åŠ ä¸€ä¸ªTokenï¼Œä¹Ÿå¯ä½¿ç”¨åˆå§‹åŒ–é…ç½®çš„Tokenã€‚
<div align=center>
  <img src=/images/2023.11.17/202719.png />
</div></li>
<li><p><strong>åœ¨Dockerä¸­å®‰è£…Grafana</strong></p>
<p>è¿™é‡Œä½¿ç”¨Grafanaå®˜æ–¹å‘½ä»¤:</p>
<div align=center>
  <img src=/images/2023.11.17/200401.png />
</div>

<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">docker</span> run -d --name=grafana -p <span class="number">3000</span>:<span class="number">3000</span> grafana/grafana-enterprise:<span class="number">10</span>.<span class="number">2</span>.<span class="number">1</span>-ubuntu</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>ä¸ºGrafanaé…ç½®å¹¶è¿›è¡Œåˆæ­¥æµ‹è¯•</strong><br>æ‰“å¼€<a href="http://127.0.0.1:3000/">http://127.0.0.1:3000</a> è¿›å…¥Grafanaé¢æ¿å¹¶é€‰æ‹© è¿æ¥-&gt;æ•°æ®æº-&gt;æ·»åŠ æ•°æ®æº-&gt;Influxdb é…ç½®ä¸€ä¸ªæ•°æ®æº</p>
<div align=center>
  <img src=/images/2023.11.17/201957.png />
</div>
é…ç½®ä¿¡æ¯åŠç»†èŠ‚è§ä¸‹å›¾
<div align=center>
  <img src=/images/2023.11.17/204922.png />
</div>
<div align=center>
  <img src=/images/2023.11.17/205752.png />
</div>
ç„¶åå¯¼å…¥Grafanaæ§åˆ¶å°æ¨¡æ¿ï¼Œè¿™é‡Œè¾“å…¥ä»£ç ï¼š13315è¿›è¡Œå¯¼å…¥ï¼Œåœ¨Grafanaå®˜ç½‘è¿˜æœ‰å…¶ä»–æ¨¡æ¿ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œäº†è§£
<div align=center>
  <img src=/images/2023.11.17/212454.png />
</div>
æ³¨æ„è¿™é‡Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œç¬”è€…åœ¨ç¬¬ä¸€æ¬¡é…ç½®çš„æ—¶å€™å‘ç°Grafanaæ— æ³•æ­£å¸¸æ˜¾ç¤ºæ•°æ®ã€‚
<div align=center>
  <img src=/images/2023.11.17/213004.png />
</div>
ç¬”è€…æ¨æµ‹æ˜¯æ¨¡æ¿ä¸­çš„Fluxè¯­å¥ä¸å®‰è£…çš„Influxdbç‰ˆæœ¬æœ‰ç•¥å¾®çš„å·®åˆ«ï¼Œäºæ˜¯ç¬”è€…é‡å†™äº†æ¨¡æ¿ä¸­çš„Fluxè¯­å¥ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Influxdb Bucketä¸­çš„æ•°æ®æˆåŠŸåœ¨Grafanaä¸­æ˜¾ç¤ºå‡ºæ¥ã€‚
<div align=center>
  <img src=/images/2023.11.17/211018.png />
</div>
ç¬”è€…å°†ä¿®æ”¹åçš„æ¨¡æ¿çš„jsonæ–‡ä»¶æ”¾åœ¨è¿™é‡Œæä¾›è¯»è€…ä¸‹è½½ï¼Œè¯»è€…å°†jsonå¯¼å…¥Grafanaæ¨¡æ¿å³å¯ã€‚</li>
</ul>
<ul>
<li><a href="/downloads/influxdb-2.0-oss-metrics.json">â¬‡ï¸â¬‡ï¸â¬‡ï¸ç‚¹å‡»ä¸‹è½½jsonæ–‡ä»¶</a></li>
</ul>
<ul>
<li><p><strong>åœ¨æ ‘è“æ´¾ä¸»æœºä¸­å®‰è£…Telegraf</strong></p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> update &amp;&amp; sudo apt-<span class="built_in">get</span> install telegraf</span><br></pre></td></tr></table></figure>

<p>Telegrafï¼Œå¯åŠ¨ï¼</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="literal">start</span> telegraf</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä½ å¸Œæœ›æ ‘è“æ´¾æ¯æ¬¡å¼€æœºTelegraféƒ½èƒ½å¯åŠ¨å°±æ‰§è¡Œè¯¥è¯­å¥</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> telegraf</span><br></pre></td></tr></table></figure></li>
<li><p><strong>æœ€åä¸€æ­¥</strong><br>é¦–å…ˆæ˜¯Influxdbï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Bucketåœ¨LoadDataä¸­é€‰æ‹©Telegrafï¼Œé»˜è®¤çš„inputsé€‰æ‹©Systemå³å¯</p>
<div align=center>
  <img src=/images/2023.11.17/221438.png />
</div>
å°†ä¸‹åˆ—configå¤åˆ¶åˆ°ä¸Šå›¾çš„æ ‡æ³¨å¤„ï¼Œè¿™äº›ä¼šå†³å®šTelegrafä¼šé‡‡é›†å“ªäº›ç±»å‹çš„æ•°æ®è¾“å…¥åˆ°Influxdbä¸­

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="string">[[inputs.cpu]]</span></span><br><span class="line">percpu = <span class="literal">true</span></span><br><span class="line">totalcpu = <span class="literal">true</span></span><br><span class="line">collect_cpu_time = <span class="literal">false</span></span><br><span class="line">report_active = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.disk]]</span></span><br><span class="line">ignore_fs = [<span class="string">&quot;tmpfs&quot;</span>, <span class="string">&quot;devtmpfs&quot;</span>, <span class="string">&quot;devfs&quot;</span>, <span class="string">&quot;iso9660&quot;</span>, <span class="string">&quot;overlay&quot;</span>, <span class="string">&quot;aufs&quot;</span>, <span class="string">&quot;squashfs&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.diskio]]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.kernel]]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.mem]]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.processes]]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.swap]]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[inputs.system]]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨å‰é¢ä»¥åŠå®Œæˆäº†Telegrafç„¶åè¿™é‡ŒInfluxdbå‘Šè¯‰æˆ‘ä»¬åªéœ€å®Œæˆ2.å’Œ3.å³å¯å°†Telegraf linkèµ·æ¥</p>
<div align=center>
  <img src=/images/2023.11.17/222122.png />
</div>
æ¥ä¸‹æ¥åœ¨æ ‘è“æ´¾ç»ˆç«¯è¿½åŠ Telegraf é…ç½®ï¼Œç¼–è¾‘telegraf.conf

<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">nano <span class="regexp">/etc/</span>telegraf/telegraf.conf</span><br></pre></td></tr></table></figure>

<p>è¿½åŠ ä»¥ä¸‹å†…å®¹å¹¶ä¿å­˜</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[[outputs.influxdb_v2]]</span></span><br><span class="line"><span class="attr">urls</span> = [<span class="string">&quot;http://127.0.0.1:8086&quot;</span>]</span><br><span class="line"><span class="attr">token</span> = <span class="string">&quot;$INFLUX_TOKEN&quot;</span></span><br><span class="line"><span class="attr">organization</span> = <span class="string">&quot;ä½ çš„Organization&quot;</span></span><br><span class="line"><span class="attr">bucket</span> = <span class="string">&quot;ä½ çš„Bucket&quot;</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€å®ŒæˆInfluxdbåˆšåˆšæç¤ºä½ çš„ç¬¬äºŒæ­¥ï¼Œåœ¨æ ‘è“æ´¾ä¸­è¾“å…¥æŒ‡ä»¤(<INFLUX_TOKEN> è§influxdbæç¤º)</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">INFLUX_TOKEN</span>=&lt;INFLUX_TOKEN&gt;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å®ŒæˆInfluxdbåˆšåˆšæç¤ºä½ çš„ç¬¬ä¸‰æ­¥ï¼Œåœ¨æ ‘è“æ´¾ä¸­è¾“å…¥æŒ‡ä»¤(<URI> è§influxdbæç¤ºï¼Œè¿½åŠ â€“debugä¼šå°†è°ƒè¯•æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°)</p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line">telegraf --config `&lt;URI&gt;` --debug</span><br></pre></td></tr></table></figure>

<p>éšååœ¨æ§åˆ¶å°è§‚å¯Ÿæœ‰ä»¥ä¸‹æ—¥å¿—è¾“å‡ºè¯´æ˜é…ç½®æˆåŠŸäº†</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! <span class="symbol">Starting</span> <span class="symbol">Telegraf</span> <span class="number">1.21</span><span class="number">.4</span>+ds1<span class="number">-0</span>ubuntu2</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! <span class="symbol">Loaded</span> inputs: cpu disk diskio kernel mem processes swap system</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! <span class="symbol">Loaded</span> aggregators:</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! <span class="symbol">Loaded</span> processors:</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! <span class="symbol">Loaded</span> outputs: influxdb_v2</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! <span class="symbol">Tags</span> enabled: host=raspberry</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">I</span>! [agent] <span class="symbol">Config</span>: <span class="symbol">Interval</span>:<span class="number">10</span>s, <span class="symbol">Quiet</span>:false, <span class="symbol">Hostname</span>:<span class="string">&quot;raspberry&quot;</span>, <span class="symbol">Flush</span> <span class="symbol">Interval</span>:<span class="number">10</span>s</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">D</span>! [agent] <span class="symbol">Initializing</span> plugins</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">D</span>! [agent] <span class="symbol">Connecting</span> outputs</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">D</span>! [agent] <span class="symbol">Attempting</span> connection to [outputs.influxdb_v2]</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">D</span>! [agent] <span class="symbol">Successfully</span> connected to outputs.influxdb_v2</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">32</span><span class="symbol">Z</span> <span class="symbol">D</span>! [agent] <span class="symbol">Starting</span> service inputs</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">40</span><span class="symbol">Z</span> <span class="symbol">D</span>! [inputs.disk] [<span class="symbol">SystemPS</span>] partition <span class="number">0</span>: &#123;<span class="string">&quot;device&quot;</span>:<span class="string">&quot;sysfs&quot;</span>,<span class="string">&quot;mountpoint&quot;</span>:<span class="string">&quot;/sys&quot;</span>,<span class="string">&quot;fstype&quot;</span>:<span class="string">&quot;sysfs&quot;</span>,<span class="string">&quot;opts&quot;</span>:[<span class="string">&quot;rw&quot;</span>,<span class="string">&quot;nosuid&quot;</span>,<span class="string">&quot;nodev&quot;</span>,<span class="string">&quot;noexec&quot;</span>,<span class="string">&quot;relatime&quot;</span>]&#125;</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">40</span><span class="symbol">Z</span> <span class="symbol">D</span>! [inputs.disk] [<span class="symbol">SystemPS</span>] -&gt; using mountpoint <span class="string">&quot;/sys&quot;</span>...</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">40</span><span class="symbol">Z</span> <span class="symbol">D</span>! [inputs.disk] [<span class="symbol">SystemPS</span>] =&gt; kept...</span><br><span class="line"><span class="number">2023</span><span class="number">-11</span><span class="number">-17</span><span class="symbol">T15</span>:<span class="number">00</span>:<span class="number">40</span><span class="symbol">Z</span> <span class="symbol">D</span>! [inputs.disk] [<span class="symbol">SystemPS</span>] partition <span class="number">1</span>: &#123;<span class="string">&quot;device&quot;</span>:<span class="string">&quot;proc&quot;</span>,<span class="string">&quot;mountpoint&quot;</span>:<span class="string">&quot;/proc&quot;</span>,<span class="string">&quot;fstype&quot;</span>:<span class="string">&quot;proc&quot;</span>,<span class="string">&quot;opts&quot;</span>:[<span class="string">&quot;rw&quot;</span>,<span class="string">&quot;nosuid&quot;</span>,<span class="string">&quot;nodev&quot;</span>,<span class="string">&quot;noexec&quot;</span>,<span class="string">&quot;relatime&quot;</span>]&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>æ¥ç€æˆ‘ä»¬åœ¨Grafanaæ·»åŠ ä¸€ä¸ªä»¥Telegraf Bucketçš„æ–°æ•°æ®æºï¼Œç„¶ååœ¨Grafanaä¸­å¯¼å…¥ä»£ç ä¸º14126çš„Telegrafæ¨¡æ¿ï¼Œè¯»è€…å¯æ¸©ä¹ å‰é¢çš„é…ç½®æ­¥éª¤ã€‚æœ€åé¢æ¿æ•°æ®æˆåŠŸå±•ç¤ºåœ¨Grafanaä¸­ï¼Œå¤§åŠŸå‘Šæˆï¼Œæ”¶å·¥ï¼</p>
<div align=center>
  <img src=/images/2023.11.17/231039.png />
</div></li>
</ul>
<h1 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h1><p>è¯»è€…å¯åœ¨è‡ªå·±å¼€å‘çš„åº”ç”¨ä¸­ä½¿ç”¨InfluxDB Client&#x2F;APIå°†æ•°æ®å­˜å‚¨åˆ°Influxdbä¸­è¿›è¡Œç³»ç»Ÿç›‘æ§ä¸æ•°æ®åˆ†æã€‚ä»¥Javaä¸ºä¾‹ï¼Œæ¯”è¾ƒå…¸å‹çš„æ˜¯åˆ©ç”¨Micrometer + InfluxDB + Grafanaå°†æœåŠ¡å™¨ã€JVMå’ŒApplicationåº¦é‡æŒ‡æ ‡è¿›è¡Œç›‘æ§åˆ†æã€‚</p>
<p>æ•´ä¸ªé…ç½®è¿‡ç¨‹ç¬”è€…çš„æ­¥éª¤ç¨å¤šï¼Œéœ€ç»†å¿ƒï¼Œç›¸ä¿¡è¯»è€…ä¹Ÿèƒ½é€šè¿‡è¿™ç¯‡æ–‡ç« å°‘è¸©ä¸€äº›å‘å°‘èµ°äº›å¼¯è·¯ã€‚</p>
]]></content>
      <categories>
        <category>ç¯å¢ƒæ­å»º</category>
        <category>åº”ç”¨ç›‘æ§</category>
      </categories>
      <tags>
        <tag>æ ‘è“æ´¾</tag>
        <tag>Ubuntu</tag>
        <tag>Docker</tag>
        <tag>Telegraf</tag>
        <tag>Influxdb</tag>
        <tag>Grafana</tag>
      </tags>
  </entry>
  <entry>
    <title>Infludb FluxæŒ‡å—</title>
    <url>/2023/11/18/0003/</url>
    <content><![CDATA[<h1 id="å¼€å§‹ä½¿ç”¨Flux"><a href="#å¼€å§‹ä½¿ç”¨Flux" class="headerlink" title="å¼€å§‹ä½¿ç”¨Flux"></a>å¼€å§‹ä½¿ç”¨Flux</h1><h2 id="æŸ¥è¯¢InfluxDB"><a href="#æŸ¥è¯¢InfluxDB" class="headerlink" title="æŸ¥è¯¢InfluxDB"></a>æŸ¥è¯¢InfluxDB</h2><p>æœ¬æŒ‡å—å°†ä»‹ç»ä½¿ç”¨ Flux ä» InfluxDB æŸ¥è¯¢æ•°æ®çš„åŸºç¡€çŸ¥è¯†ã€‚ æ¯ä¸ª Flux æŸ¥è¯¢éƒ½éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>æ•°æ®æº</li>
<li>æ—¶é—´èŒƒå›´</li>
<li>æ•°æ®ç­›é€‰å™¨</li>
</ol>
<h3 id="å®šä¹‰æ•°æ®æº"><a href="#å®šä¹‰æ•°æ®æº" class="headerlink" title="å®šä¹‰æ•°æ®æº"></a>å®šä¹‰æ•°æ®æº</h3><p>Fluxçš„<a href="https://docs.influxdata.com/flux/v0/stdlib/influxdata/influxdb/from/"><code>from()</code></a>å‡½æ•°å®šä¹‰ä¸€ä¸ª InfluxDB æ•°æ®æºã€‚ å®ƒéœ€è¦ä¸€ä¸ª<a href="https://docs.influxdata.com/flux/v0/stdlib/influxdata/influxdb/from/#bucket"><code>bucket</code></a>å‚æ•°ã€‚ ä»¥ä¸‹ç¤ºä¾‹ç”¨ä½œå­˜å‚¨æ¡¶åç§°ã€‚example-bucket</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>:<span class="string">&quot;example-bucket&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="æŒ‡å®šæ—¶é—´èŒƒå›´"><a href="#æŒ‡å®šæ—¶é—´èŒƒå›´" class="headerlink" title="æŒ‡å®šæ—¶é—´èŒƒå›´"></a>æŒ‡å®šæ—¶é—´èŒƒå›´</h3><p>Flux åœ¨æŸ¥è¯¢æ—¶åºæ•°æ®æ—¶éœ€è¦æ—¶é—´èŒƒå›´ã€‚â€œæ— ç•Œâ€æŸ¥è¯¢éå¸¸è€—è´¹èµ„æºï¼Œä½œä¸ºä¸€ç§ä¿æŠ¤æªæ–½ï¼Œ å¦‚æœæ²¡æœ‰æŒ‡å®šèŒƒå›´ï¼ŒFlux ä¸ä¼šæŸ¥è¯¢æ•°æ®åº“ã€‚</p>
<p>ä½¿ç”¨ç®¡é“å‘å‰è¿ç®—ç¬¦(|&gt;)å°†æ•°æ®ä»æ•°æ®æºç®¡é“ä¼ è¾“åˆ°<a href="https://docs.influxdata.com/flux/v0/stdlib/universe/range"><code>range()</code></a>ä¸­ï¼Œåè€…æŒ‡å®šæŸ¥è¯¢çš„æ—¶é—´èŒƒå›´ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šå¯åŠ¨å’Œåœæ­¢ã€‚å¼€å§‹å€¼å’Œåœæ­¢å€¼å¯ä»¥æ˜¯ä½¿ç”¨è´ŸæŒç»­æ—¶é—´çš„ç›¸å¯¹å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨æ—¶é—´æˆ³çš„ç»å¯¹å€¼ã€‚</p>
<p><strong>ç¤ºä¾‹ç›¸å¯¹æ—¶é—´èŒƒå›´</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Relative time range with start only. Stop defaults to now.</span></span><br><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>:<span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Relative time range with start and stop</span></span><br><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>:<span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h, <span class="attr">stop</span>: -10m)</span><br></pre></td></tr></table></figure>

<p>ç›¸å¯¹èŒƒå›´æ˜¯ç›¸å¯¹äºâ€œç°åœ¨â€çš„ã€‚</p>
<p><strong>ç»å¯¹æ—¶é—´èŒƒå›´ç¤ºä¾‹</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>:<span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: <span class="number">2021</span>-<span class="number">01</span>-01<span class="attr">T00</span>:<span class="number">00</span>:00Z, <span class="attr">stop</span>: <span class="number">2021</span>-<span class="number">01</span>-01<span class="attr">T12</span>:<span class="number">00</span>:00Z)</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</strong></p>
<p>åœ¨æœ¬æŒ‡å—ä¸­ï¼Œè¯·ä½¿ç”¨ç›¸å¯¹æ—¶é—´èŒƒå›´ ï¼Œå°†æŸ¥è¯¢ç»“æœé™åˆ¶ä¸ºè¿‡å» 15 åˆ†é’Ÿçš„æ•°æ®ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>:<span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -15m)</span><br></pre></td></tr></table></figure>

<h3 id="è¿‡æ»¤æ•°æ®"><a href="#è¿‡æ»¤æ•°æ®" class="headerlink" title="è¿‡æ»¤æ•°æ®"></a>è¿‡æ»¤æ•°æ®</h3><p>å°†èŒƒå›´å†…çš„æ•°æ®ä¼ é€’åˆ°filter()ä¸­ï¼Œä»¥æ ¹æ®æ•°æ®å±æ€§æˆ–åˆ—ç¼©å°ç»“æœã€‚filter()æœ‰ä¸€ä¸ªå‚æ•°fnï¼Œå®ƒè¦æ±‚è°“è¯å‡½æ•°æŒ‰åˆ—å€¼è®¡ç®—è¡Œã€‚<br>filter()å¯¹æ¯ä¸ªè¾“å…¥è¡Œè¿›è¡Œè¿­ä»£ï¼Œå¹¶å°†è¡Œæ•°æ®æ„é€ ä¸ºFluxè®°å½•ã€‚è®°å½•ä½œä¸ºrä¼ é€’åˆ°è°“è¯å‡½æ•°ä¸­ï¼Œåœ¨é‚£é‡Œä½¿ç”¨è°“è¯è¡¨è¾¾å¼å¯¹å…¶æ±‚å€¼ã€‚</p>
<p>è®¡ç®—ç»“æœä¸ºfalseçš„è¡Œå°†ä»è¾“å‡ºæ•°æ®ä¸­åˆ é™¤ã€‚è®¡ç®—ç»“æœä¸ºtrueçš„è¡Œå°†ä¿ç•™åœ¨è¾“å‡ºæ•°æ®ä¸­ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Pattern</span></span><br><span class="line">(r) =&gt; (r.<span class="property">recordProperty</span> comparisonOperator comparisonExpression)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example with single filter</span></span><br><span class="line">(r) =&gt; (r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example with multiple filters</span></span><br><span class="line">(r) =&gt; (r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> != <span class="string">&quot;usage_system&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><strong>ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</strong></p>
<p>å¯¹äºæœ¬ä¾‹ï¼Œæ ¹æ®cpuæµ‹é‡å€¼ã€usage_systemå­—æ®µå’Œcpuæ€»æ ‡è®°å€¼è¿›è¡Œç­›é€‰ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -15m)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="ç”ŸæˆæŸ¥è¯¢çš„æ•°æ®"><a href="#ç”ŸæˆæŸ¥è¯¢çš„æ•°æ®" class="headerlink" title="ç”ŸæˆæŸ¥è¯¢çš„æ•°æ®"></a>ç”ŸæˆæŸ¥è¯¢çš„æ•°æ®</h3><p><a href="https://docs.influxdata.com/flux/v0/stdlib/universe/yield/"><code>yield()</code></a>è¾“å‡ºæŸ¥è¯¢ç»“æœã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -15m)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">yield</span>()</span><br></pre></td></tr></table></figure>

<p>Fluxåœ¨æ¯ä¸ªè„šæœ¬çš„æœ«å°¾è‡ªåŠ¨é‡‡ç”¨yield()å‡½æ•°æ¥è¾“å‡ºå’Œå¯è§†åŒ–æ•°æ®ã€‚åªæœ‰åœ¨åŒä¸€FluxæŸ¥è¯¢ä¸­åŒ…å«å¤šä¸ªæŸ¥è¯¢æ—¶ï¼Œæ‰éœ€è¦æ˜¾å¼è°ƒç”¨yield()ã€‚æ¯ä¸€ç»„è¿”å›çš„æ•°æ®éƒ½éœ€è¦ä½¿ç”¨yield()å‡½æ•°è¿›è¡Œå‘½åã€‚</p>
<h2 id="ä½¿ç”¨-Flux-è½¬æ¢æ•°æ®"><a href="#ä½¿ç”¨-Flux-è½¬æ¢æ•°æ®" class="headerlink" title="ä½¿ç”¨ Flux è½¬æ¢æ•°æ®"></a>ä½¿ç”¨ Flux è½¬æ¢æ•°æ®</h2><p>ä» InfluxDB æŸ¥è¯¢æ•°æ®æ—¶ï¼Œé€šå¸¸éœ€è¦ä»¥æŸç§æ–¹å¼è½¬æ¢è¿™äº›æ•°æ®ã€‚ å¸¸è§çš„ç¤ºä¾‹åŒ…æ‹¬èšåˆæ•°æ®ã€ç¼©å‡é‡‡æ ·æ•°æ®ç­‰ã€‚</p>
<p>æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨Fluxå‡½æ•°è½¬æ¢æ•°æ®ã€‚å®ƒéå†åˆ›å»ºä¸€ä¸ªFluxè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†æ•°æ®åˆ’åˆ†ä¸ºæ—¶é—´çª—å£ï¼Œå¯¹æ¯ä¸ªçª—å£ä¸­çš„_valuesè¿›è¡Œå¹³å‡ï¼Œå¹¶å°†å¹³å‡å€¼è¾“å‡ºä¸ºä¸€ä¸ªæ–°è¡¨ã€‚</p>
<h3 id="æŸ¥è¯¢æ•°æ®"><a href="#æŸ¥è¯¢æ•°æ®" class="headerlink" title="æŸ¥è¯¢æ•°æ®"></a>æŸ¥è¯¢æ•°æ®</h3><p>ä½¿ç”¨å‰é¢çš„ä» InfluxDB æŸ¥è¯¢æ•°æ®æŒ‡å—ä¸­æ„å»ºçš„æŸ¥è¯¢ï¼Œä½†æ›´æ–°èŒƒå›´ä»¥æå–æœ€åä¸€å°æ—¶çš„æ•°æ®ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="é€šé‡å‡½æ•°"><a href="#é€šé‡å‡½æ•°" class="headerlink" title="é€šé‡å‡½æ•°"></a>é€šé‡å‡½æ•°</h3><p>Fluxæä¾›äº†è®¸å¤šæ‰§è¡Œç‰¹å®šæ“ä½œã€è½¬æ¢å’Œä»»åŠ¡çš„å‡½æ•°ã€‚æ‚¨è¿˜å¯ä»¥åœ¨FluxæŸ¥è¯¢ä¸­åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ã€‚Fluxæ ‡å‡†åº“æ–‡æ¡£ä¸­è¯¦ç»†ä»‹ç»äº†å‡½æ•°ã€‚<br>è½¬æ¢ä»InfluxDBæŸ¥è¯¢çš„æ•°æ®æ—¶ä½¿ç”¨çš„ä¸€ç§å¸¸è§ç±»å‹çš„å‡½æ•°æ˜¯èšåˆå‡½æ•°ã€‚èšåˆå‡½æ•°è·å–è¡¨ä¸­çš„ä¸€ç»„_valuesï¼Œèšåˆå®ƒä»¬ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºæ–°å€¼ã€‚</p>
<p>æœ¬ä¾‹ä½¿ç”¨<a href="https://docs.influxdata.com/flux/v0/stdlib/universe/mean"><code>mean()</code></a>å‡½æ•°å¯¹æ¯ä¸ªæ—¶é—´çª—å£å†…çš„å€¼è¿›è¡Œå¹³å‡ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹ä»‹ç»äº†çª—å£åŒ–å’Œèšåˆæ•°æ®æ‰€éœ€çš„æ­¥éª¤ï¼Œä½†æœ‰ä¸€ä¸ª<a href="https://docs.influxdata.com/influxdb/v2/query-data/get-started/transform-data/#helper-functions"><code>aggregateWindow()</code></a>è¾…åŠ©å‡½æ•°å¯ä»¥å¸®æ‚¨å®Œæˆè¿™é¡¹å·¥ä½œã€‚äº†è§£è¿™ä¸ªè¿‡ç¨‹ä¸­çš„æ­¥éª¤æ˜¯å¾ˆå¥½çš„ã€‚</p>
<h3 id="æŸ¥çœ‹æ•°æ®çª—å£"><a href="#æŸ¥çœ‹æ•°æ®çª—å£" class="headerlink" title="æŸ¥çœ‹æ•°æ®çª—å£"></a>æŸ¥çœ‹æ•°æ®çª—å£</h3><p>Fluxçš„<a href="https://docs.influxdata.com/flux/v0/stdlib/universe/window"><code>window()</code></a>å‡½æ•°æ ¹æ®æ—¶é—´å€¼å¯¹è®°å½•è¿›è¡Œåˆ†åŒºã€‚ä½¿ç”¨everyå‚æ•°å¯ä»¥å®šä¹‰æ¯ä¸ªçª—å£çš„æŒç»­æ—¶é—´ã€‚</p>
<p><strong>æ—¥å†æœˆå’Œå¹´</strong></p>
<p>æ—¥å†æœˆä»½å’Œå¹´ä»½<br>everyæ”¯æŒæ‰€æœ‰æœ‰æ•ˆçš„æŒç»­æ—¶é—´å•ä½ï¼ŒåŒ…æ‹¬æ—¥å†æœˆ(1mo)å’Œå¹´(1y)ã€‚</p>
<p>å¯¹äºæœ¬ä¾‹ï¼Œçª—å£æ•°æ®çš„é—´éš”ä¸º5åˆ†é’Ÿ(5m)ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">window</span>(<span class="attr">every</span>: 5m)</span><br></pre></td></tr></table></figure>

<p>å½“æ•°æ®è¢«æ”¶é›†åˆ°æ—¶é—´çª—å£ä¸­æ—¶ï¼Œæ¯ä¸ªçª—å£éƒ½ä½œä¸ºè‡ªå·±çš„è¡¨è¾“å‡ºã€‚å½“å¯è§†åŒ–æ—¶ï¼Œæ¯ä¸ªè¡¨éƒ½è¢«åˆ†é…äº†ä¸€ç§å”¯ä¸€çš„é¢œè‰²ã€‚</p>
<p><img src="https://docs.influxdata.com/img/flux/windowed-data.png" alt="çª—å£åŒ–æ•°æ®è¡¨"></p>
<h3 id="èšåˆçª—å£åŒ–æ•°æ®"><a href="#èšåˆçª—å£åŒ–æ•°æ®" class="headerlink" title="èšåˆçª—å£åŒ–æ•°æ®"></a>èšåˆçª—å£åŒ–æ•°æ®</h3><p>Fluxèšåˆå‡½æ•°è·å–æ¯ä¸ªè¡¨ä¸­çš„sï¼Œå¹¶ä»¥æŸç§æ–¹å¼èšåˆå®ƒä»¬ã€‚ ä½¿ç”¨ _value <a href="https://docs.influxdata.com/flux/v0/stdlib/universe/mean"><code>mean()</code></a>å‡½æ•°å¯¹æ¯ä¸ªè¡¨çš„sæ±‚å¹³å‡å€¼ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">window</span>(<span class="attr">every</span>: 5m)</span><br><span class="line">    |&gt; <span class="title function_">mean</span>()</span><br></pre></td></tr></table></figure>

<p>å½“æ¯ä¸ªçª—å£ä¸­çš„è¡Œè¢«èšåˆæ—¶ï¼Œå®ƒä»¬çš„è¾“å‡ºè¡¨åªåŒ…å«ä¸€ä¸ªå…·æœ‰èšåˆå€¼çš„è¡Œã€‚çª—å£åŒ–çš„è¡¨ä»ç„¶æ˜¯ç‹¬ç«‹çš„ï¼Œå½“å¯è§†åŒ–æ—¶ï¼Œå®ƒä»¬å°†æ˜¾ç¤ºä¸ºå•ä¸ªçš„ã€ä¸ç›¸è¿çš„ç‚¹ã€‚</p>
<p><img src="https://docs.influxdata.com/img/flux/windowed-aggregates.png" alt="çª—å£åŒ–èšåˆæ•°æ®"></p>
<h3 id="å‘èšåˆæ·»åŠ æ—¶é—´"><a href="#å‘èšåˆæ·»åŠ æ—¶é—´" class="headerlink" title="å‘èšåˆæ·»åŠ æ—¶é—´"></a>å‘èšåˆæ·»åŠ æ—¶é—´</h3><p>åœ¨èšåˆå€¼æ—¶ï¼Œç”Ÿæˆçš„è¡¨æ²¡æœ‰_timeåˆ—ï¼Œå› ä¸ºç”¨äºèšåˆçš„è®°å½•éƒ½å…·æœ‰ä¸åŒçš„æ—¶é—´æˆ³ã€‚èšåˆå‡½æ•°ä¸ä¼šæ¨æ–­èšåˆå€¼åº”è¯¥ä½¿ç”¨çš„æ—¶é—´ã€‚å› æ­¤ï¼Œ_timeåˆ—è¢«åˆ é™¤ã€‚</p>
<p>åœ¨ä¸‹ä¸€ä¸ªæ“ä½œä¸­éœ€è¦_timeåˆ—ã€‚ è¦æ·»åŠ ä¸€ä¸ªï¼Œè¯·ä½¿ç”¨<a href="https://docs.influxdata.com/flux/v0/stdlib/universe/duplicate"><code>duplicate()</code></a>å‡½æ•°å°†_stopåˆ—å¤åˆ¶ä¸ºæ¯ä¸ªçª—å£è¡¨çš„_timeåˆ—ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">window</span>(<span class="attr">every</span>: 5m)</span><br><span class="line">    |&gt; <span class="title function_">mean</span>()</span><br><span class="line">    |&gt; <span class="title function_">duplicate</span>(<span class="attr">column</span>: <span class="string">&quot;_stop&quot;</span>, <span class="attr">as</span>: <span class="string">&quot;_time&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="å–æ¶ˆçª—å£èšåˆè¡¨"><a href="#å–æ¶ˆçª—å£èšåˆè¡¨" class="headerlink" title="å–æ¶ˆçª—å£èšåˆè¡¨"></a>å–æ¶ˆçª—å£èšåˆè¡¨</h3><p>å°†window()å‡½æ•°ä¸every:infå‚æ•°ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥å°†æ‰€æœ‰ç‚¹èšé›†åˆ°ä¸€ä¸ªå•ä¸€çš„æ— é™çª—å£ä¸­ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">window</span>(<span class="attr">every</span>: 5m)</span><br><span class="line">    |&gt; <span class="title function_">mean</span>()</span><br><span class="line">    |&gt; <span class="title function_">duplicate</span>(<span class="attr">column</span>: <span class="string">&quot;_stop&quot;</span>, <span class="attr">as</span>: <span class="string">&quot;_time&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">window</span>(<span class="attr">every</span>: inf)</span><br></pre></td></tr></table></figure>

<p>ä¸€æ—¦å–æ¶ˆåˆ†ç»„å¹¶ç»„åˆåˆ°ä¸€ä¸ªè¡¨ä¸­ï¼Œèšåˆæ•°æ®ç‚¹å°†åœ¨å¯è§†åŒ–ä¸­æ˜¾ç¤ºä¸ºè¿æ¥çš„ã€‚</p>
<p><img src="https://docs.influxdata.com/img/flux/windowed-aggregates-ungrouped.png" alt="æœªçª—å£èšåˆæ•°æ®"></p>
<h3 id="å¸®åŠ©ç¨‹åºå‡½æ•°"><a href="#å¸®åŠ©ç¨‹åºå‡½æ•°" class="headerlink" title="å¸®åŠ©ç¨‹åºå‡½æ•°"></a><strong>å¸®åŠ©ç¨‹åºå‡½æ•°</strong></h3><p>è¿™ä¼¼ä¹åªæ˜¯ä¸ºäº†æ„å»ºä¸€ä¸ªèšåˆæ•°æ®çš„æŸ¥è¯¢è€Œè¿›è¡Œçš„å¤§é‡ç¼–ç ï¼Œç„¶è€Œï¼Œé€šè¿‡è¿™ä¸ªè¿‡ç¨‹æœ‰åŠ©äºäº†è§£æ•°æ®åœ¨é€šè¿‡æ¯ä¸ªå‡½æ•°æ—¶æ˜¯å¦‚ä½•æ”¹å˜â€œå½¢çŠ¶â€çš„ã€‚</p>
<p>Fluxæä¾›(å¹¶å…è®¸æ‚¨åˆ›å»º)â€helperâ€å‡½æ•°ï¼Œè¿™äº›å‡½æ•°æŠ½è±¡äº†å…¶ä¸­çš„è®¸å¤šæ­¥éª¤ã€‚æœ¬æŒ‡å—ä¸­æ‰§è¡Œçš„ç›¸åŒæ“ä½œå¯ä»¥ä½¿ç”¨<a href="https://docs.influxdata.com/flux/v0/stdlib/universe/aggregatewindow"><code>aggregateWindow()</code></a>å®Œæˆã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">from</span>(<span class="attr">bucket</span>: <span class="string">&quot;example-bucket&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">range</span>(<span class="attr">start</span>: -1h)</span><br><span class="line">    |&gt; <span class="title function_">filter</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="property">_measurement</span> == <span class="string">&quot;cpu&quot;</span> and r.<span class="property">_field</span> == <span class="string">&quot;usage_system&quot;</span> and r.<span class="property">cpu</span> == <span class="string">&quot;cpu-total&quot;</span>)</span><br><span class="line">    |&gt; <span class="title function_">aggregateWindow</span>(<span class="attr">every</span>: 5m, <span class="attr">fn</span>: mean)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>æŒ‡å—</category>
        <category>æ•°æ®åº“</category>
      </categories>
      <tags>
        <tag>Influxdb</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¤¼ç‰©</title>
    <url>/2023/10/17/0001/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="ffc65383f44b0b01a671139ce2102223c89e3a8724d3e38eede81d375b70318b">3e83d50de96ca2207a1aba1932db313a1b91373322dd25f3c27f364062631a34c8f40da60edcd32558c4f32607e8be22a081300a2d482a4da94066949fe4b6216c536697f20520762c35504531b69c84e884bd08493b15cee4c14a15ca63e2bf1648be51fa7e78ebdbdd591147d61399525b90900414ea06cf454dfd501d0f8a18b0e74a31850e31238d67ba29642a733154ef5e240872a66dd3c62c636e47c0d0eb4d9de7c734c17e39734dd4437eccf4fe674a664239ed6dc2dd61700760cd06941e239c43183123e087431f7d0abd697e900fe24485dd98a954ed4add69381cda0c786971e48e11615e8cff3c7aa1c8329769ac6df1597f3e2b4f76a2e680e8c29fa6183bcf6a8ea25006af0c9446df4d78698fa2909fd8db51ab7f428bf6314b0c415ae62db222a2edff49f4d28930e5120a1af2d4c7bd7135503cda50361e1c053fde83f081d63c2ac06cdc374fcf9dcac6ddd8727d3865e121d1f754e90207fc9f7c88038f62c6b8cba6808afcc00e6f37ae83f9789bbb376e11a121fd9aa8d7d062287faf0e35c497b40781e858a57c9ef611c24996d25465e3b3b6e0f7322c516e013c1fa916b24472902a8e6f750affa3431374d6f384151df82d97c366cb8442fd09e281afd01648d8b231</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">è¯·è¾“å…¥è®¿é—®ç </span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>å‹äººå¸</category>
      </categories>
  </entry>
</search>
